# Tools
 - `Runas`
 - `Sharphound`
 - `Bloodhound`
 - `PowerView`

# Enumerating trough Microsoft Management Console (MMC)
## Using Runas
If we have the AD credentials in the format of :, we can use Runas, a legitimate Windows binary, to inject the credentials into memory. The usual Runas command would look something like this:
> runas.exe /netonly /user:\<domain\>\<username> cmd.exe

| Command               | Description                                                                                         |
| :---                  | :---                                                                                                |
| `/netonly`            | Load the credentials for network authentication but not authenticate against a domain controller. No credentials will be verified and will accept any password  |         
| `/user`               | Use the Fully Qualified Domain Name (FQDN)                                                          |
| `cmd.exe`             | Execute the program, in this case a command line interface                                          |
  
_Note: If you use your own Windows machine, you should make sure that you run your first Command Prompt as Administrator. This will inject an `Administrator token` into CMD. If you run tools that require local Administrative privileges from your Runas spawned CMD, the token will already be available. This does not give you administrative privileges on the network, but will ensure that any local commands you execute, will execute with administrative privileges._
  
# Manually configure DNS
Using the IP of the domain controller, we can execute the following commands in a PowerShell window:

Get Domain Controller IP:
> nslookup \<DOMAIN>
  
```PowerShell
$dnsip = "<DC IP>"
$index = Get-NetAdapter -Name 'Ethernet' | Select-Object -ExpandProperty 'ifIndex'
Set-DnsClientServerAddress -InterfaceIndex $index -ServerAddresses $dnsip
```
Aftr this verify that our credentials are working. The most surefire way to do this is to list `SYSVOL`. *Any AD account, no matter how low-privileged, can read the contents of the SYSVOL directory.*  

Force a network-based listing of the SYSVOL directory
> dir \\\\DOMAIN\SYSVOL\

_Note: When we provide the hostname, network authentication will attempt first to perform Kerberos authentication. Since Kerberos authentication uses hostnames embedded in the tickets, if we provide the IP instead, we can force the authentication type to be NTLM. While on the surface, this does not matter, it is good to understand these slight differences since they can allow you to remain more stealthy during a Red team assessment. In some instances, organisations will be monitoring for OverPass- and Pass-The-Hash Attacks. Forcing NTLM authentication is a good trick to have in the book to avoid detection in these cases._

## Microsoft Management Console (MMC)
This is where the Runas window comes into play. In that window, we can start MMC, which will ensure that all MMC network connections will use our injected AD credentials. You can start MMC by using the Windows Start button, searching run, and typing in MMC.

In MMC, we can now attach the AD RSAT Snap-In:

1. Click `File -> Add/Remove Snap-in`
2. Select and `Add` all three Active Directory Snap-ins
3. Click through any errors and warnings
4. Right-click on `Active Directory Domains and Trusts` and select `Change Forest`
5. Enter `<DOMAIN>` as the `Root domain` and Click `OK`
6. Right-click on `Active Directory Sites and Services` and select `Change Forest`
7. Enter `<DOMAIN>` as the `Root domain` and Click `OK`
8. Right-click on `Active Directory Users and Computers` and select `Change Domain`
9. Enter `<DOMAIN>` as the `Domain` and Click `OK`
10. Right-click on `Active Directory Users and Computers` in the left-hand pane
11. Click on `View -> Advanced Features`

If everything up to this point worked correctly, your MMC should now be pointed to, and authenticated against, the target Domain:

## Users and Computers
Look at 
 - AD Users and Computers.
 - Organisational Unit (OU) structure. 
 - User groups
 - Hosts and workstations

| Bnefits                                                       | Drawbacks                                                                               |
| :---                                                          | :---                                                                                    |
| The GUI provides an excellent method to gain a holistic view of the AD environment. | The GUI requires RDP access to the machine where it is executed.  |
| Rapid searching of different AD objects can be performed. | Although searching for an object is fast, gathering AD wide properties or attributes cannot be performed. |
| It provides a direct method to view specific updates of AD objects. |                                                                                   |
| If we have sufficient privileges, we can directly update existing AD objects or add new ones.                                                           |

# Enumeration through Command Prompt 
CMD has a built-in command that we can use to enumerate information about AD, namely `net`. The `net` command is a handy tool to enumerate information about the local system and AD. We will look at a couple of interesting things we can enumerate from this position, but this is not an exhaustive list.

## Users

| Command                          | Description                                                                  |
| :---                             | :---                                                                         |
| `net user /domain`               | List all users in the AD domain                                              |
| `net user <USERNAME> /domain`    | List moirie detailed information about a specific user                       |

## Groups

| Command                                | Description                                                      |
| :---                                   | :---                                                             |
| `net group /domain`                    | List all groups in the AD domain                                 |
| `net group "<GROUP_NAME>" /domain`     | List moirie detailed information about a specific user           |

## Password Policy

| Command                                | Description                                                      |
| :---                                   | :---                                                             |
| `net accounts /domain`                 | List all password policy in the AD domain                        |


| Bnefits                                                       | Drawbacks                                                                               |
| :---                                                          | :---                                                                                    |
| No additional or external tooling is required, and these simple commands are often not monitored for by the Blue team. | The net commands must be executed from a domain-joined machine. If the machine is not domain-joined, it will default to the WORKGROUP domain.                                               |
| We do not need a GUI to do this enumeration.                  | The net commands may not show all information. For example, if a user is a member of more than ten groups, not all of these groups will be shown in the output.                                                                                          |
| VBScript and other macro languages that are often used for phishing payloads support these commands natively so they can be used to enumerate initial information regarding the AD domain before more specific payloads are crafted. |                                                                          |

# Enumeration using PowerShell

## Users

| Command                                                                                                | Description                             |
| :---                                                                                                   | :---                                    |
| `Get-ADUser -Identity <USERNAME> -Server <DOMAIN> -Properties *`                                       | Enumerate specific users                |
| `Get-ADUser -Filter 'Name -like "*<USERNAME>"' -Server <DOMAIN> | Format-Table Name,SamAccountName -A` | Filter and format for display structure |

The parameters are used for the following:
 - `Identity` - The account name that we are enumerating
 - `Properties` - Which properties associated with the account will be shown, * will show all properties
 - `Server` - Since we are not domain-joined, we have to use this parameter to point it to our domain controller

## Groups

| Command                                                       | Description                             |
| :---                                                          | :---                                    |
| `Get-ADGroup -Identity <GROUP_NAME> -Server <DOMAIN>`         | Enumerate specific groups               |
| `Get-ADGroupMember -Identity <GROUP_NAME> -Server <DOMAIN>`   | Enumaerate group memberships            |

## AD Objects
We can use generic search tools to look through AD for specific details. We can start by creating a variable. For this example we will use AD Objects that were changed after a specific date:
 > $ChangeDate = New-Object DateTime(2022, 02, 28, 12, 00, 00)

| Command                                                                                      | Description                             |
| :---                                                                                         | :---                                    |
| `Get-ADObject -Filter 'whenChanged -gt $ChangeDate' -includeDeletedObjects -Server <DOMAIN>` | Special Search                          |
| `Get-ADObject -Filter 'badPwdCount -gt 0' -Server <DOMAIN>` | Enumerate accounts that have a badPwdCount that is greater than 0, to avoid these accounts in our attack |
| `Set-ADAccountPassword -Identity <USERNAME> -Server <DOMAIN> -OldPassword (ConvertTo-SecureString -AsPlaintext "old" -force) -NewPassword (ConvertTo-SecureString -AsPlainText "new" -Force)` | Alter exiting user detail, change password |  

## Domains

| Command                               | Description                                      |
| :---                                  | :---                                             |
| `Get-ADDomain -Server <DOMAIN>`       | Get additional information about specific domain |


| Bnefits                                                       | Drawbacks                                                                               |
| :---                                                          | :---                                                                                    |
| The PowerShell cmdlets can enumerate significantly more information than the net commands from Command Prompt. |   PowerShell is often monitored more by the blue teams than Command Prompt. | 
| We can specify the server and domain to execute these commands using runas from a non-domain-joined machine. | We have to install the AD-RSAT tooling or use other, potentially detectable, scripts for PowerShell enumeration. | 
| We can create our own cmdlets to enumerate specific information.
| We can use the AD-RSAT cmdlets to directly change AD objects, such as resetting passwords or adding a user to a specific group.


# Enumeration using PowerView


# Enumerating thorugh Bloodhound
## Using Sharphound
Command line for Sharphound
> Sharphound.exe --CollectionMethods <Methods> --Domain <DOMAIN> --ExcludeDCs 

 - `CollectionMethods` - Determines what kind of data Sharphound would collect. The most common options are Default or All. Also, since Sharphound caches information, once the first run has been completed, you can only use the Session collection method to retrieve new user sessions to speed up the process.
 - `Domain` - Here, we specify the domain we want to enumerate. In some instances, you may want to enumerate a parent or other domain that has trust with your existing domain. You can tell Sharphound which domain should be enumerated by altering this parameter.
 - `ExcludeDCs` -This will instruct Sharphound not to touch domain controllers, which reduces the likelihood that the Sharphound run will raise an alert.

We can then ingest the file to Bloodhound
 
## Using Bloodhound
Bloodhound uses Neo4j as its backend database and graphing system.
> neo4j console start
 
In another Terminal tab, run `bloodhound --no-sandbox`. This will show you the authentication GUI. The default credentials for the neo4j database will be `neo4j:neo4j`
 
There are several attack paths that Bloodhound can show. Pressing the three stripes next to "Search for a node" will show the options. The very first tab shows us the information regarding our current imports. 

We can see that there is a significant amount of information returned regarding our use. Each of the categories provides the following information:
 - `Overview` - Provides summaries information such as the number of active sessions the account has and if it can reach high-value targets.
 - `Node Properties` - Shows information regarding the AD account, such as the display name and the title.
 - `Extra Properties` - Provides more detailed AD information such as the distinguished name and when the account was created.
 - `Group Membership` - Shows information regarding the groups that the account is a member of.
 - `Local Admin Rights` - Provides information on domain-joined hosts where the account has administrative privileges.
 - `Execution Rights` - Provides information on special privileges such as the ability to RDP into a machine.
 - `Outbound Control Rights` - Shows information regarding AD objects where this account has permissions to modify their attributes.
 - `Inbound Control Rights` -  Provides information regarding AD objects that can modify the attributes of this account. 
 
| Bnefits                                                       | Drawbacks                                                                               |
| :---                                                          | :---                                                                                    | 
| Provides a GUI for AD enumeration. | Requires the execution of Sharphound, which is noisy and can often be detected by AV or EDR solutions. |
| Has the ability to show attack paths for the enumerated AD information. | |
| Provides more profound insights into AD objects that usually require several manual queries to recover. | |
    
 
 
 
